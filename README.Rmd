---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  fig.path = "man/figures/README-"
  #out.width = "100%"
)
```

# dualmarker
<!-- badges: start -->
<!-- badges: end -->

*dualmarker* is designed to facilitate the data mining of dual biomarkers. It provides intuitive visualizations and extensive assessment of two marker combinations using logistic regression model for binary response outcome and Cox models for survival analysis. ![dualmarker_overview](man/figures/dualmarker_overview.png)

## Installation

- Install the latest developmental version from [GitHub](https://github.com/kassambara/rstatix) as follow: 

```{r, eval = FALSE}
if(!require(devtools)) install.packages("devtools")
devtools::install_github("maxiaopeng/dualmarker")
```

## key functions

### dm_pair
*dm_pair* return the list of 'response' and 'survival', which contains plot in 'plot' and statistics in 'stats', shown in the following structure:

+ response.plot
   - boxplot
   - scatter.chart
   - four.quadrant
   - roc
+ response.stats
   - logit
   - four.quadrant
      - param
      - stats
+ survival.plot
   - km.m1m2
   - scatter.m1m2
   - km.dualmarker
   - km.dualmarker.facet
   - scatter.dualmarker
   - four.quadrant
+ survival.stats
   - cox
   - four.quadrant
      - param
      - stats

the overview plot:
![dualmarker_plot](man/figures/dualmarker_pair_plot.png)

### *dm_searchM2_logit*
### *dm_searchM2_cox*

## dataset
We demonstrate the data using [Imvigor210](http://research-pub.gene.com/IMvigor210CoreBiologies) biomarker data. The demographic info, clinical efficacy and biomarker data is stored in **clin_bmk_IMvigor210** dataframe, with gene expression containing 'gep_' prefix, gene signature score containing 'gepscore_' prefix and mutation containing 'mut_' prefix. The gene expression profiling(GEP) data is pre-processed according to the IMvigor210CoreBiologies package. Gene signature score is calculated for *hallmark* genesets from MsigDBv7.0 as well as signatures from the IMvigor210CoreBiologies package. 


```{r, include=F}
library(dualmarker)
library(stringr)
library(dplyr)
```

## Example1
Here we demonstrate the combination of TMB and TGF-beta gene signature for response analysis using *dm_pair* function. This pair of biomarker is studied in [Nature.2018 Feb 22;554(7693):544-548](https://pubmed.ncbi.nlm.nih.gov/29443960/).
The *response* should be dichotomous by setting *response.pos* and *response.neg* values.
```{r example, fig.width=6, fig.height=5}
## basic example code
res.pair <- dm_pair(data = clin_bmk_IMvigor210, 
                    response = "binaryResponse",  
                    response.pos = "CR/PR", response.neg = "SD/PD", 
                    marker1 = "TMB", marker2 = "gepscore_TGFb.19gene")
```

* plot1: single marker for response
correlation between single marker and response is shown in boxplot, and pvalue of wilcoxon test between positive and negative response is added to the plot.
```{r, fig.width=6, fig.height=4}
res.pair$response.plot$boxplot
```

* plot2: Scatter-chart for response
The correlation between marker1, maker2 and response is shown in scatter-chart. If marker1 or marker2 is categorical, the jitter plot is shown with color indicating response. 
```{r, fig.width=4, fig.height=3}
res.pair$response.plot$scatter.chart
```

* plot3: Four-quadrant plot of response
Samples are split into four groups/quadrants, according to cutoff for continuous markers, default using 'median'. The independence of each quadrant is tested by Fisher exact test. Response rate, sample size and confidence interval are shown in matrix, donut chart and line chart. For the donut chart, response rate is corresponding to red arc fraction and sample size to width of ring, and the line chart reveals the response rate and potential statistical interaction for two markers if lines are crossed.
```{r, fig.width=6, fig.height=5}
res.pair$response.plot$four.quadrant
```

* plot4: ROC curve
The single and dual marker prediction of response is also shown on ROC curve. Logistics regression model is applied w/ or w/o interaction term between two biomarkers. AUC value and its confidence interval is also drawn on the graph.
```{r, fig.width=5, fig.height=4}
res.pair$response.plot$roc
```

* plot5: survival plot
not available here, see in next example

* plot6: Four-quadrant plot of survival
not available here, see in next example

* stats1: Four-quadrant statistics of response
*$stats$response.4quad* contains four-quadrant statistics of response

+ *param* contains the note of marker1,marker2, cutoff methods et al
+ *stats* contains the sample number, resposne rate and its confidence interval in each quadrant, R1-R4

```{r}
res.4q <- res.pair$response.stats$four.quadrant
res.4q$param
res.4q$stats
```

* stats2: logistic regression result
Four logistic regression models are built, and model comparison is performed to test the difference of dual-marker model and single-marker model by Likihood ratio test(LRT) using *anova* function for model3-vs-model1, model4-vs-model1, model3-vs-model2, model4-vs-model2.

+ model1: R ~ m1, labeled as 'M1' for short
+ model2: R ~ m2, labeled as 'M2' for short
+ model3: R ~ m1 + m2, labeled as 'MD' for short, i.e. dual-marker
+ model4: R ~ m1 * m2 (with interaction term), labeled as 'MDI' for short, i.e. dual-marker with interaction

Logistic regression models return the following information
1. basic parameters: response, marker1(m1), marker2(m2), cut point of for continuous m1/m2, positive/negative values for categorical m1/2
2. logistic regression parameters: the weight(estimate) and p-value(Wald test) of each predictive variable in model1(m1), model2(m2), model3(md), model4(mdi). 'mdi_.m1:.m2_estimate' and 'mdi_.m1:.m2_pval' is the interaction term for marker1 and marker2.
3. AIC: AIC of model-m1,m2,md and mdi
4. model comparison: p-value of LRT for m1-vs-null(R ~ 1, no marker), m2-vs-null, m1-vs-md, m2-vs-md, m1-vs-mdi, m2-vs-mdi. 

```{r}
dplyr::glimpse(res.pair$response.stats$logit)
```

* stats-3:   Four-quadrant statistics of survival 
not available here, see next example

* stats-4:  Cox regression result
not available here, see next example

## Example2
Here we demonstrated the visualization of CXCL13 expression and ARID1A mutation status, this biomarker pair is studied by [Sci Transl Med. 2020 Jun 17;12(548):eabc4220](https://pubmed.ncbi.nlm.nih.gov/32554706/), we showed the same result.
```{r fig.width=6, fig.height=5}
res.pair <- dm_pair(data = clin_bmk_IMvigor210, 
               # survival info
               time = "os", event = "censOS",
               marker1 = "mut_ARID1A",  
               m1.cat.pos = "YES", m1.cat.neg = "NO",
               marker2 = "gep_HMGB1",
               m2.num.cut = "median")
```

* plot-1: single markers for response
Not available here
* plot-2: scatter chart for response
Not available here

* plot-3: Four-quadrant response rate, not shown here
Not available here

* plot-4: ROC curve, not shown here
Not available here

* plot-5: single marker for survival
```{r,  fig.width=8, fig.height=4}
res.pair$survival.plot$km.m1m2
res.pair$survival.plot$scatter.m1m2
```

plot-6: dual marker for survival
```{r,  fig.width=5, fig.height=4.5}
res.pair$survival.plot$km.dualmarker
res.pair$survival.plot$km.dualmarker.facet
res.pair$survival.plot$scatter.dualmarker
```


plot-7: four-quadrant show of survival
```{r, fig.width=6, fig.height=4.5}
res.pair$survival.plot$four.quadrant
```

* stats-1: four quadrant response
not shown here

* stats-2: summary of logit for response
not shown here

* stats-3: four quadrant stats of survival
```{r}
stats.4q <- res.pair$survival.stats$four.quadrant
stats.4q$param
stats.4q$stats
```

stats-4:  stats of cox
```{r}
dplyr::glimpse(res.pair$survival.stats$cox)
```

## Example3
find the candidate marker2 in gene expression to combine with ARID1A mutation
```{r}
m2.candidates <- stringr::str_subset(colnames(clin_bmk_IMvigor210),"gep_") 
res.m2.cox <- dm_searchM2_cox(
  data = clin_bmk_IMvigor210, 
   # survival
   time = "os", 
   event = "censOS",
   # marker1
   marker1 = "mut_ARID1A", 
   m1.binarize = T, 
   m1.cat.pos = "YES", 
   m1.cat.neg = "NO", 
   # marker2
   m2.candidates = m2.candidates
  )
```

Plot the searchM2 result, the top20 most significant marker2 is shown
```{r}
plot.m2.cox <- dm_searchM2_topPlot(res.m2.cox, top.n = 20)
```

* plot-1, marker2 effect.
'm2_effect' is dot-chart, showing the top significant marker2s, whose introduction to dual-maker model(w/ or w/o interaction) significantly increase the prediction of survival. Likelihood ratio test(LRT) is carried out to compare dual-marker model and marker1 solo model, the signed log10-pValue is shown on x-axis, and 'sign' indicates the effect direction of marker2 to survival.
```{r, fig.width=5, fig.height=4}
plot.m2.cox$m2_effect
```

* plot-2, marker2's interaction. 
'interaction' is dot-chart, showing the top significant marker2s, which has statistical interaction with given marker1. Signed log10-pValue is shown like 'm2_effect'
```{r, fig.width=4, fig.height=4}
plot.m2.cox$interact
```

* plot-3: m1 and m2 effect
'm1_m2_effect' is scatter-plot, showing the log10-pValue of model comparison, i.e. dual-vs-marker1 and dual-vs-marker2. Dual model that superior to both marker1 and marker2 is preferred, located top-right on the figure.
```{r,fig.height=4, fig.width=4}
plot.m2.cox$m1_m2_effect
```

* stats-1: cox result
```{r}
dplyr::glimpse(res.m2.cox)
```


## Related articles

- [Nature.2018 Feb 22;554(7693):544-548](https://pubmed.ncbi.nlm.nih.gov/29443960/)
- [Sci Transl Med. 2020 Jun 17;12(548):eabc4220](https://pubmed.ncbi.nlm.nih.gov/32554706/)

